<div>
  <button class="btn btn-info btn-sm" onclick="uploadFileDialog();"><span class="glyphicon glyphicon-cloud-upload"></span>上传</button>
  <input id="fileupload" name="files[]" type="file" multiple style="display: none;">
  <button class="btn btn-default btn-sm" onclick="createNewFolder('/index.html', '{{ query.path }}');"><span class="glyphicon glyphicon-folder-open" style="color: #aa6;"></span> 新建文件夹</button>
  <button class="btn btn-default btn-sm btnopt hidden" onclick="checkMoveToOpt()" style="margin-left: 15px;">移动</button>
  <button class="btn btn-default btn-sm btnopt hidden" onclick="checkCopyToOpt()">复制</button>
  <button class="btn btn-default btn-sm btnopt hidden" onclick="checkDelToOpt()">删除</button>
</div>
<div id="progress" class="hidden" style="float: left;">
  <div style="margin: 10px 0; border-radius: 4px; width: 500px; background: #c3c3c3">
    <div class="barname" style="float: left;  color: white;"></div>
	<div class="barpercent" style="margin-right: 10px; float: right;  color: white;">0%</div>
    <div class="bar" style="width: 0%; height: 20px; background: #338833;"></div>
  </div>
</div>
<br><br>
{% if selectData.lastlink %}
<a href="/index.html?action=all&path={{ selectData.lastlink.link }}">返回上一级</a><span> | </span>
{% endif %}
<span>位置：</span>
{% for loc in selectData.locallist %}
{% if loc.index != selectData.locallist.length %}
<a href="/index.html?action=all&path={{ loc.link }}">{{ loc.path }}</a>
{% else %}
<span>{{ loc.path }}</span>
{% endif %}
{% if loc.type == 'd' %}/{% endif %}
{% endfor %}
<div><!--class="table-responsive"-->
  <table class="table table-hover" style="min-width: 460px;">
    <thead>
    <tr>
      <th style="width: 40px;"><input id="checkall" type="checkbox" onclick="checkAll('checkall')"></th>
      <th>文件名</th>
	  <th style="width: 80px;"></th>
      <th style="text-align: center; width: 80px;">大小</th>
      <th style="text-align: center; width: 180px;"><!--修改日期--></th>
    </tr>
    </thead>
    <tbody id="gwtbody">
	{% for file in selectData.files %}
    <tr id="tr{{ file.index }}">
      <td><input type="checkbox" onclick="trcheck()" fpath="{{ file.path }}"></td>
	  <td class="tdname">
	    <a href="/index.html?action=all&path={{ file.path }}">
	    {% if file.type == '-' %}
	    <span class="glyphicon glyphicon-file" style="color: #a8a8a8;"> </span>
		{% else %}
		<span class="glyphicon glyphicon-folder-close" style="color: #dfdf00;"> </span>
		{% endif %}
		{{ file.name }}</a>
	  </td>
	  <td>
	  <div class="ringo-moreopt-nav">
	    <a><span title="分享" class="glyphicon glyphicon-share" style="margin: 0 2px;"></span></a>
	    <a href="javascript:downloadToOpt(['{{ file.path }}']);" class="downlink">
		  <span title="下载" class="glyphicon glyphicon-download-alt" style="margin: 0 2px;"></span>
		</a>
		<div class="dropdown" style="margin: 0 2px; float: right;">
          <a href="javascript: void(0);"  id="dropdownmoreopt" class="dropdown-toggle" data-toggle="dropdown">
		    <span title="更多" class="glyphicon glyphicon-option-horizontal"></span>
		  </a>
          <ul class="dropdown-menu" aria-labelledby="dropdownmoreopt">
	        <li><a href="javascript:moveToOpt(['{{ file.path }}']);" class="mvlink">移动</a></li>
			<li><a href="javascript:copyToOpt(['{{ file.path }}']);" class="cplink">复制</a></li>
			<li><a href="javascript:renameOpt('tr{{ file.index }}');">重命名</a></li>
			<li><a href="javascript:removeFile('/index.html', '{{ file.path }}');" class="rmlink">删除</a></li>
	      </ul>
		</div>
	  </div>
	  </td>
	  {% if file.type == '-' %}
	  <td style="font-family: times; text-align: center;">{{ file.size }}</td>
	  {% else %}
	  <td style="text-align: center;">-</td>
	  {% endif %}
	  <td style="text-align: center; font-family: times;">{{ file.date }}</td>
    </tr>
	{% endfor %}
    </tbody>
  </table>
</div>
<div id="queryfolderModal" class="modal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><a class="close" data-dismiss="modal">×</a>
        <h4>标题</h4>
      </div>
      <div class="modal-body">
		<div id="macor" class="accordion">
		  <div class="accordion-group">
		    <div class="accordion-heading">
			  <a href="javascript:getFoldersListByPath('/index.html', '/', 'macor', neutralOpt)" style="text-decoration: none;">
			    <span class="glyphicon glyphicon-folder-close" style="color: #dfdf00;"></span> 全部文件
			  </a>
			</div>
		  </div>
		</div>
      </div>
      <div class="modal-footer">
	    <button type="button" class="btn btn-info" onclick="filesToQueryFolder('/index.html');" data-dismiss="modal">确定</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
  <input id="queryaction"  type="hidden">
  <input id="querysrcarr"  type="hidden">
  <input id="querytarget"  type="hidden">
</div>
<script type="text/javascript" src="/static/js/jquery.ui.widget.js"></script>
<script type="text/javascript" src="/static/js/jquery.iframe-transport.js"></script>
<script type="text/javascript" src="/static/js/jquery.fileupload.js"></script>
<script type="text/javascript" src="/static/js/FileSaver.min.js"></script>
<script>
$(function () {
  'use strict';
  $('#fileupload').fileupload({
        url: '/index.html',
		type: 'PUT',
        dataType: 'json',
		/*add: function (e, data) {
			data.submit();
		},*/
        done: function (e, data) {
            $.each(data.result.files, function (index, file) {
                console.log('Uploadfile Done: ' + JSON.stringify(file));
            });
			window.location.reload();
        },
		progressall: function (e, data) {
			var progress = parseInt(data.loaded / data.total * 100, 10);
			var bitrate = '';
			if(data.bitrate < 1024*8) {
			  bitrate = (data.bitrate/8).toFixed(2) + 'B';
			}
			else if(data.bitrate < 1024*1024*8) {
			  bitrate = (data.bitrate/1024/8).toFixed(2) + 'KB';
			}
			else if(data.bitrate < 1024*1024*1024*8) {
			  bitrate = (data.bitrate/1024/1024/8).toFixed(2) + 'MB';
			}
			else if(data.bitrate < 1024*1024*1024*1024*8) {
			  bitrate = (data.bitrate/1024/1024/1024/8).toFixed(2) + 'G';
			}

			if(progress == 100) {
			  $('#progress').addClass('hidden');
			}
			else {
			  $('#progress').removeClass('hidden');
			}

			var barname = $('#progress .barname');
			var barpercent = $('#progress .barpercent');
			var bar = $('#progress .bar');

			var name = '正在上传';
			switch(barname.attr('index')) {
			case '1':
				name += '.&nbsp;&nbsp;&nbsp;&nbsp;';
				barname.attr('index', '2');
				break;

			case '2':
				name += '..&nbsp;&nbsp;&nbsp;';
				barname.attr('index', '3');
				break;

			case '3':
				name += '...&nbsp;&nbsp;';
				barname.attr('index', '0');
				break;

			default:
				name += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
				barname.attr('index', '1');
				break;
			}

			barname.html(name + bitrate);
			barpercent.text(progress + '%');
			bar.css('width', progress + '%');
		}
    });
})

function createNewFolder(url, path) {
  $.post(url, {opt: 'newfolder', path: path}, function(data, status) {
    if(status == 'success') {
	  $('tbody').prepend('<tr id="tr' + $('#gwtbody').children().length + '"><td><input type="checkbox" onclick="trcheck()" fpath="' + path + '/' + data.folder + '"></td>'
		+ '<td class="tdname"><span class="glyphicon glyphicon-folder-close" style="color: #dfdf00;"></span>'
		+ '<input id="nfinput" type="text" value="' + data.folder + '" onblur="renameNewFolder(\'' + url + '\', \'' + path + '\', \'nfinput\')"  name="' + data.folder + '" /></td>'
		+ '<td><div class="ringo-moreopt-nav">'
	    + '<a><span title="分享" class="glyphicon glyphicon-share" style="margin: 0 2px;"></span></a>'
	    + '<a href="javascript:downloadToOpt([\'' + path + '/' + data.folder + '\']);">'
		+ '<span title="下载" class="glyphicon glyphicon-download-alt" style="margin: 0 2px;"></span></a>'
		+ '<div class="dropdown" style="margin: 0 2px; float: right;">'
        + '<a href="javascript: void(0);"  id="dropdownmoreopt" class="dropdown-toggle" data-toggle="dropdown"><span title="更多" class="glyphicon glyphicon-option-horizontal"></span></a>'
        + '<ul class="dropdown-menu" aria-labelledby="dropdownmoreopt">'
	    + '<li><a href="javascript:moveToOpt([\'' + path + '/' + data.folder + '\']);" class="mvlink">移动</a></li>'
		+ '<li><a href="javascript:copyToOpt([\'' + path + '/' + data.folder + '\']);" class="cplink">复制</a></li>'
		+ '<li><a href="javascript:renameOpt(\'tr' + $('#gwtbody').children().length + '\');">重命名</a></li>'
		+ '<li><a href="javascript:removeFile(\'/index.html\', \'' + path + '/' + data.folder + '\');" class="rmlink">删除</a></li>'
	    + '</ul></div></div></td>'
		+ '<td style="text-align: center;">-</td>'
		+ '<td style="text-align: center; font-family: times;">' + data.date + '</td></tr>');

	  $('#nfinput').focus();
	}
	else {
	  alert("新建文件夹失败！");
	}
  });
}

function renameNewFolder(url, path, inputId) {
  var file = $('#'+inputId).attr('name');
  var newfile = $('#'+inputId).val();

  $.post(url, {opt: 'renamefile', path: path, file: file, newfile: newfile}, function(data, status) {
    var filename = file;
    if(status == 'success') {
	  filename = newfile;
	}
	else if(status == 'notmodified') {
	}
	else {
	  console.log(file + " 重命名失败！");
	}

	var filelink = encodeURIComponent((path + '/' + filename).replace(/\/{2,}/g, "/"))

	$('#'+inputId).parent().parent().find('input[type="checkbox"]').attr('fpath', filelink);
	$('#'+inputId).parent().parent().find('.downlink').attr('href', 'javascript:downloadToOpt([\'' + filelink + '\']);');
	$('#'+inputId).parent().parent().find('.mvlink').attr('href', 'javascript:moveToOpt([\'' + filelink + '\']);');
	$('#'+inputId).parent().parent().find('.cplink').attr('href', 'javascript:copyToOpt([\'' + filelink + '\']);');
	$('#'+inputId).parent().parent().find('.rmlink').attr('href', 'javascript:removeFile(\'/index.html\', \'' + filelink + '\');');
	$('#'+inputId).parent().html('<a href="/index.html?action=all&path=' + filelink + '"><span class="glyphicon glyphicon-folder-close" style="color: #dfdf00;"></span> ' + filename + '</a>');
  });
}

function checkAll(id) {
  if($('#'+id).prop('checked')) {
    $('td input[type="checkbox"]').prop('checked', true);
  }
  else {
	$('td input[type="checkbox"]').prop('checked', false);
  }

  trcheck();
}

function trcheck() {
  var hascheck = false;
  var allcheck = true;

  $('#gwtbody td input[type="checkbox"]').each(function() {
    if($(this).prop('checked')) {
	  hascheck = true;
	}
	else {
	  allcheck = false;
	}
  });

  if(hascheck) {
    $('.btnopt').removeClass('hidden');
  }
  else {
    $('.btnopt').addClass('hidden');
	$('#checkall').prop('checked', false);
  }

  if(allcheck) {
    $('#checkall').prop('checked', true);
  }
}

function checkMoveToOpt() {
  moveToOpt(getCheckPath());
}

function checkCopyToOpt() {
  copyToOpt(getCheckPath());
}

function checkDelToOpt() {
  removeFile('/index.html', getCheckPath());
}

function getCheckPath() {
  var filearr = [];
  $('#gwtbody td input[type="checkbox"]').each(function() {
    if($(this).prop('checked')) {
	  filearr.push($(this).attr('fpath'));
	}
  });

  return filearr;
}

function downloadToOpt(srcarr) {
  for(var x in srcarr) {
    var path = decodeURIComponent(srcarr[x]);
	var fname = path.split('/').pop();

	var xhr = new XMLHttpRequest();
    xhr.open('GET', '/owncloud/remote.php/webdav' + path, true);
    xhr.setRequestHeader("Authorization", '{{ authKey }}');
	xhr.responseType = 'blob';
    xhr.onload = function() {
	  if (this.status == 200) {
		var blob = this.response;
		saveAs(blob, fname);
	  }
	}
	xhr.send();
  }
}

function moveToOpt(srcarr) {
  getFoldersListByPath('/index.html', '/', 'macor', function(toggle, path, id, folders){
    selectFolderPath(toggle, path, id, folders, 'mv', srcarr);
  }, true);
}

function copyToOpt(srcarr) {
  getFoldersListByPath('/index.html', '/', 'macor', function(toggle, path, id, folders){
    selectFolderPath(toggle, path, id, folders, 'cp', srcarr);
  }, true);
}

function neutralOpt(toggle, path, id, folders){
  selectFolderPath(toggle, path, id, folders, 'neu');
}

function selectFolderPath(toggle, path, id, folders, action, srcarr) {

  if(action == 'mv') {
    $('#queryfolderModal .modal-header h4').text('移动到 ' + path);
	$('#queryaction').val('movefile');
	$('#querysrcarr').val(JSON.stringify(srcarr));
	$('#querytarget').val(path);
    $('#queryfolderModal').modal('show');
  }
  else if(action == 'cp') {
    $('#queryfolderModal .modal-header h4').text('复制到 ' + path);
	$('#queryaction').val('copyfile');
	$('#querysrcarr').val(JSON.stringify(srcarr));
	$('#querytarget').val(path);
    $('#queryfolderModal').modal('show');
  }
  else if(action == 'neu') {
    if($('#queryaction').val() == 'movefile') {
	  $('#queryfolderModal .modal-header h4').text('移动到 ' + path);
	}
	else if($('#queryaction').val() == 'copyfile') {
	  $('#queryfolderModal .modal-header h4').text('复制到 ' + path);
	}
	$('#querytarget').val(path);
  }

  if(!toggle) {
    appendFoldersList(id, path, folders);
  }
}

function appendFoldersList(id, path, folders) {

  var gralen = path.split('/').length;
  if(path == '/') {
    gralen = 1;
  }

  var y = 0;
  var grapre = '';
  while(y++ < gralen) {
    grapre += '&nbsp&nbsp&nbsp&nbsp';
  }

  grapre += '|--';

  $('#'+id+' .accordion-group').html($('#'+id+' .accordion-group').children().get(0));
  $('#'+id+' .accordion-group').append(
	'<div class="accordion-body collapse in"><div class="accordion-inner"></div></div>'
  );

  for(var x in folders) {
    var linkpath = (path + '/' + folders[x]).replace(/\/{2,}/g, '/');
	var linkid = linkpath.replace(/[\/\(\)]/g, '-');

    $('#'+id+' .accordion-body .accordion-inner').append(
	  '<div id="' + linkid + '" class="accordion"><div class="accordion-group"><div class="accordion-heading">'
	  + '<a href="javascript:getFoldersListByPath(\'/index.html\', \'' + linkpath + '\', \'' + linkid + '\', neutralOpt)" style="text-decoration: none;">' + grapre + ' <span class="glyphicon glyphicon-folder-close" style="color: #dfdf00;"></span> ' + folders[x]+ '</a>'
	  + '</div></div></div>'
	);
  }
}

function removeFile(url, path) {
  $.post(url, {opt: 'removefile', path: path}, function(data, status) {
    if(status == 'success') {
	  window.location.href=data;
	}
	else {
	  alert('文件删除失败！');
	}
  });
}

function renameOpt(id) {
  var filename = $('#'+id).find('.tdname').text().trim();
  $('#'+id).find('.tdname').html('<input id="nfinput" type="text" value="' + filename + '" onblur="renameNewFolder(\'/index.html\', \'{{ query.path }}\', \'nfinput\')"  name="' + filename + '" />');
  $('#nfinput').focus();
}

function getFoldersListByPath(url, path, id, callback, untoggle) {

  if($('#'+id+' .accordion-body').length > 0 && !untoggle) {
    $('#'+id+' .collapse').collapse('toggle');
	callback(true, path);
  }
  else {
    $.post(url, {opt: 'getfolders', path: path}, function(data, status) {
      if(status == 'success' && typeof callback == 'function') {
	    callback(false, path, id, data.folders);
	  }
    });
  }
}

function filesToQueryFolder(url) {
  $.post(url, {
      opt: $('#queryaction').val(),
	  srcarr: $('#querysrcarr').val(),
	  target: $('#querytarget').val()
	},
	function(data, status) {
	  if(status == 'success') {
	    window.location.href=data;
	  }
	}
  );
}

function uploadFileDialog() {
  $('input[type="file"]').click();
}
</script>
